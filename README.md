# 辩论计时器系统

一个集成QQ机器人权限控制的专业辩论计时器系统。

## 功能特性

- 🎯 专业的辩论计时器界面
- 🤖 QQ机器人自动权限控制
- ⏱️ 双计时器支持（自由辩论等环节）
- 🎨 经典界面设计复刻
- 🔊 音效提醒系统
- ⌨️ 丰富的快捷键支持

## 系统架构

- **前端**: Nuxt.js + Vue 3 + TypeScript
- **后端**: QQ机器人 (botpy) + HTTP API
- **权限控制**: 自动同步辩论环节与QQ群发言权限

## 安装依赖

### 前端依赖
```bash
cd debate-timer
npm install
```

### Python依赖
```bash
pip install botpy aiohttp
```

## 配置说明

### QQ机器人配置
1. 修改 `qq.py` 中的机器人ID和Token：
```python
client.run('你的机器人ID', '你的机器人Token')
```

2. 确保机器人有以下权限：
   - 管理身份组
   - 管理频道权限
   - 发送消息

### 环节配置
在 `debate-timer/stores/debate.ts` 中可以修改辩论环节设置：
- 环节名称和时长
- 允许发言的身份组
- 环节类型（发言/质询/对辩等）

## 使用方法

### 方式一：使用启动脚本（推荐）
```bash
python start-debate-system.py
```

### 方式二：分别启动
1. 启动QQ机器人：
```bash
python qq.py
```

2. 启动前端应用：
```bash
cd debate-timer
npm run dev
```

## QQ机器人命令

### 身份组管理
- `3` - 创建所有辩论身份组
- `4` - 删除所有辩论身份组
- `我是[身份组名称]` - 加入身份组
- `我不是[身份组名称]` - 退出身份组

### 权限控制
- `允许[身份组名称]` - 给予发言权限
- `禁止[身份组名称]` - 撤销发言权限

### 身份组列表
- 正方一辩、正方二辩、正方三辩、正方四辩
- 反方一辩、反方二辩、反方三辩、反方四辩
- 后台、主持人、评委

## 快捷键说明

### 通用控制
- `空格` - 启动/暂停/切换计时器
- `P` - 中断计时
- `←/→` - 切换环节
- `F` - 全屏切换

### 双计时器专用
- `.` - 启动正方计时器
- `,` - 启动反方计时器

### 试音功能
- `Q` - 播放30秒提示音
- `W` - 播放5秒提示音
- `E` - 播放时间到提示音

## 权限控制逻辑

1. **自动权限管理**：切换环节时自动给予对应身份组发言权限
2. **永久权限**：主持人和后台始终拥有发言权限
3. **权限撤销**：切换环节时自动撤销上一环节的权限
4. **实时同步**：前端环节切换实时同步到QQ群权限
5. **状态检测**：自动检测QQ机器人连接状态，避免误报同步成功

## 连接状态说明

### 状态指示器
- 🟢 **已连接** - QQ机器人正常运行，权限同步正常
- 🔴 **QQ机器人未运行** - 机器人程序未启动
- 🔴 **QQ机器人离线** - 机器人已启动但未连接到QQ服务器
- 🟡 **正在同步...** - 正在进行权限同步操作
- 🔴 **QQ机器人无响应** - 机器人响应超时

### 状态检测机制
- 应用启动时自动检测QQ机器人状态
- 环节切换前先检查连接状态
- 3秒超时检测，避免长时间等待
- 根据不同错误类型显示具体状态信息

## 环节类型说明

- **speech**: 单人发言环节（如一辩立论）
- **question**: 质询环节（允许多人发言）
- **summary**: 总结环节（单人发言）
- **dual-timer**: 双计时器环节（如自由辩论）
- **special**: 特殊环节（如开场、评委点评）

## 测试功能

### 权限控制测试
运行测试脚本验证权限控制功能：
```bash
python test-permissions.py
```

测试内容包括：
- QQ机器人连接状态检查
- 权限设置功能测试
- 多环节权限切换测试

## 故障排除

### QQ机器人连接失败
1. 检查机器人ID和Token是否正确
2. 确认机器人已加入目标群组
3. 检查机器人权限设置

### 权限同步失败
1. 确认HTTP服务器正常运行（localhost:8080）
2. 检查网络连接
3. 查看控制台错误信息
4. 运行测试脚本检查权限设置功能

### 权限设置错误
如果出现"Timeout context manager should be used inside a task"错误：
1. 确认使用了正确的Permission对象创建方式
2. 检查botpy版本是否兼容
3. 查看QQ机器人控制台的详细错误信息

### 前端无法启动
1. 确认Node.js版本 >= 16
2. 重新安装依赖：`npm install`
3. 检查端口占用情况

## 开发说明

### 项目结构
```
├── debate-timer/           # 前端应用
│   ├── components/        # Vue组件
│   ├── stores/           # Pinia状态管理
│   ├── server/api/       # API路由
│   └── types/            # TypeScript类型定义
├── qq.py                 # QQ机器人主程序
├── start-debate-system.py # 系统启动脚本
└── README.md            # 说明文档
```

### 添加新环节
1. 在 `DEBATE_STAGES` 数组中添加环节定义
2. 设置环节类型、时长和允许发言的身份组
3. 系统会自动处理权限同步

### 自定义身份组
1. 修改 `qq.py` 中的 `role_names` 列表
2. 更新 `role_max_members` 配置
3. 在环节定义中使用新的身份组名称

## 许可证

MIT License

## 贡献

欢迎提交Issue和Pull Request来改进这个项目。